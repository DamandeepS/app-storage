<script>
  (function() {
    'use strict';

    let workerUrl = Symbol('workerUrl');
    let workerScope = Symbol('workerScope');
    let workerRegistration = Symbol('workerRegistration');
    let connectsToWorker = Symbol('connectsToWorker');
    let connected = Symbol('connected');
    let channel = Symbol('channel');
    let transactionId = Symbol('transactionId');
    let transactions = Symbol('transactions');

    let setWorker = Symbol('setWorker');
    let setWorkerRegistration = Symbol('setWorkerRegistration');
    let handleWorkerMessage = Symbol('handleWorkerMessage');

    Polymer.CarbonPersistenceClient = class CarbonPersistenceClient {
      constructor(_workerUrl, _workerScope) {
        this[workerUrl] = _workerUrl;
        this[workerScope] = _workerScope;
        this[connected] = false;
        this[workerRegistration] = null;
        this[channel] = null;
        this[transactionId] = 0;
        this[transactions] = new Map();
      }

      transaction(method, key, value) {
        return this.connect().then(port => {
          return new Promise(resolve => {
            let id = this[transactionId]++;

            port.addEventListener('message', function onMessage(event) {
              if (event.data &&
                  event.data.type === 'carbon-persistence-transaction-result' &&
                  event.data.id === id) {
                port.removeEventListener('message', onMessage);
                resolve(event.data.result);
              }
            });

            port.postMessage({
              type: 'carbon-persistence-transaction',
              id,
              method,
              key,
              value
            });
          });
        });
      }

      connect() {
        if (this[connected] || this[connectsToWorker]) {
          return this[connectsToWorker];
        }

        return this[connectsToWorker] = this.registerWorker().then(worker => {
          return new Promise(resolve => {
            this[channel] = new MessageChannel();
            this[channel].port1.addEventListener('message', event => {
              if (event.data &&
                  event.data.type === 'carbon-persistence-connected') {
                this[connected] = true;
                resolve(this[channel].port1);
              }
            });
            this[channel].port1.start();

            worker.postMessage({
              type: 'carbon-persistence-connect'
            }, [this[channel].port2]);
          });
        });
      }

      registerWorker() {
        return new Promise(resolve => {
          navigator.serviceWorker
              .register(this[workerUrl], { scope: this[workerScope] })
                  .then((registration) => {
                    resolve(this[setWorkerRegistration](registration));
                  });
        });
      }

      [setWorkerRegistration](registration) {
        return new Promise(resolve => {
          let self = this;
          if (this[workerRegistration] !== registration) {
            this[workerRegistration] = registration;
            registration.addEventListener(
                'updatefound', function onUpdateFound() {
                  registration.removeEventListener(
                      'updatefound', onUpdateFound);
                  resolve(self[setWorker](registration.installing));
                });
          }

          if (registration.active) {
            resolve(this[setWorker](registration.active));
          }
        });
      }

      [setWorker](worker) {
        return new Promise((resolve) => {
          if (worker.state === 'activated') {
            resolve(worker);
          } else {
            worker.addEventListener(
                'statechange', function onWorkerStateChange() {
                  if (worker.state === 'activated') {
                    resolve(worker);
                  } else if (worker.state === 'redundant') {
                    this[connected] = false;
                    this[connectsToWorker] = null;

                    worker.removeEventListener(
                        'statechange', onWorkerStateChange);
                  }
                });
          }
        });
      }
    }
  })();
</script>
