<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="carbon-pouchdb-database-behavior.html">
<link rel="import" href="pouchdb.html">
<link rel="import" href="pouchdb.find.html">
<script>
  (function() {
    'use strict';

    Polymer({
      is: 'carbon-pouchdb-query',

      behaviors: [
        Polymer.CarbonPouchDBDatabaseBehavior
      ],

      properties: {
        selector: {
          type: String
        },

        fields: {
          type: Array,
          value: function() {
            return [];
          }
        },

        sort: {
          type: Array,
          value: function() {
            return [];
          }
        },

        limit: {
          type: Number,
          value: 0
        },

        skip: {
          type: Number,
          value: 0
        },

        parsedSelector: {
          type: Object,
          computed: '__computeParsedSelector(selector)'
        },

        query: {
          type: Object,
          computed: '__computeQuery(db, parsedSelector, fields.*, sort.*, limit, skip)'
        },

        data: {
          type: Array,
          readOnly: true,
          value: function() {
            return [];
          }
        }
      },

      observers: [
        'refresh(db, query)'
      ],

      refresh: function() {
        if (!this.query) {
          throw new Error('Query not configured!');
        }

        this.debounce('find', function() {
          this.db.find(this.query).then(function(results) {
            this._setData(results.docs || []);
          }.bind(this)).catch(function(error) {
            this._error(error);
          }.bind(this));
        }, 1);
      },

      __computeQuery: function() {
        var query = {};

        query.selector = this.parsedSelector;
        query.fields = this.fields;
        query.sort = this.sort;

        if (this.limit) {
          query.limit = this.limit;
        }

        if (this.skip) {
          query.skip = this.skip;
        }

        return query;
      },

      __computeParsedSelector: function(selector) {
        var dimensions = selector.split(/\s*[,]\s*/);
        var parsedSelector = {};

        for (var i = 0; i < dimensions.length; ++i) {
          if (dimensions[i]) {
            this.__parseDimension(parsedSelector, dimensions[i]);
          }
        }
        return parsedSelector;
      },

      __parseDimension: function(parsedSelector, dimension) {
        var parsedDimension = {};
        var tokens = dimension.split(/\s+/);
        var field = tokens.shift();

        while (tokens.length > 1) {
          try {
            this.__parseConstraint(parsedDimension, tokens.splice(0, 2));
          } catch (e) {}
        }

        parsedSelector[field] = parsedDimension;
      },

      __parseConstraint: function(parsedDimension, constraintTokens) {
        var operator = constraintTokens[0];
        var rhs = constraintTokens[1];
        var rhsAsNumber;

        if (/^['"].*['"]$/.test(rhs)) {
          rhs = rhs.slice(1, rhs.length - 1);
        } else {
          rhsAsNumber = window.parseFloat(rhs, 10);
          if (!window.isNaN(rhsAsNumber)) {
            rhs = rhsAsNumber;
          } else {
            rhs = rhs === 'true';
          }
        }

        if (operator != null && rhs != null) {
          parsedDimension[operator] = rhs;
        }
      }
    });
  })();
</script>
