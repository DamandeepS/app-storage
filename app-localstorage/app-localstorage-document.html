<link rel="import" href="../app-storage-behavior.html">
<link rel="import" href="../../polymer/polymer.html">
<dom-module id="app-localstorage-document">
  <script>
    'use strict';

    Polymer({
      is: 'app-localstorage-document',

      behaviors: [
        Polymer.AppStorageBehavior
      ],

      properties: {
        key: {
          type: String,
          notify: true
        },

        sessionOnly: {
          type: Boolean,
          value: false
        },

        storage: {
          type: Object,
          computed: '__computeStorage(sessionOnly)'
        }
      },

      observers: [
        '__storageSourceChanged(storage, key)'
      ],

      attached: function() {
        this.listen(window, 'storage', '__onStorage');
        this.listen(
            window.top,
            'app-local-storage-changed',
            '__onAppLocalStorageChanged');
      },

      detached: function() {
        this.unlisten(window, 'storage', '__onStorage');
        this.unlisten(
            window.top,
            'app-local-storage-changed',
            '__onAppLocalStorageChanged');
      },

      get isNew() {
        return !this.key;
      },

      save: function(key) {
        try {
          this.__setStorageValue(key, this.data);
        } catch(e) {
          return Promise.reject(e);
        }

        this.key = key;

        return Promise.resolve();
      },

      reset: function() {
        this.key = null;
        this.data = this.zeroValue;
      },

      destroy: function() {
        try {
          this.storage.removeItem(this.key);
          this.reset();
        } catch (e) {
          return Promise.reject(e);
        }

        return Promise.resolve();
      },

      getStoredValue: function(path) {
        var value;

        if (this.key != null) {
          try {
            value = this.__parseValueFromStorage();

            if (value != null) {
              value = this.get(path, {
                data: value
              });
            } else {
              value = undefined;
            }
          } catch (e) {
            return Promise.reject(e);
          }
        }

        return Promise.resolve(value);
      },

      setStoredValue: function(path, value) {
        if (this.key != null) {
          try {
            this.__setStorageValue(this.key, this.data);
          } catch (e) {
            return Promise.reject(e);
          }

          this.fire('app-local-storage-changed', this, {
            node: window.top
          });
        }

        return Promise.resolve(value);
      },

      __computeStorage: function(sessionOnly) {
        return sessionOnly ? window.sessionStorage : window.localStorage;
      },

      __storageSourceChanged: function(storage, key) {
        this._initializeStoredValue();
      },

      __onStorage: function(event) {
        if (event.key !== this.key ||
            event.storageArea !== this.storage) {
          return;
        }

        this.syncToMemory(function() {
          this.set('data', this.__parseValueFromStorage());
        });
      },

      __onAppLocalStorageChanged: function(event) {
        if (event.detail === this) {
          return;
        }

        this.syncToMemory(function() {
          this.set('data', event.detail.data);
        });
      },

      __parseValueFromStorage: function() {
        try {
          return JSON.parse(this.storage.getItem(this.key));
        } catch(e) {
          console.error('Failed to parse value from storage for', this.key);
        }
      },

      __setStorageValue: function(key, value) {
        this.storage.setItem(this.key, JSON.stringify(this.data));
      }
    });
  </script>
</dom-module>
