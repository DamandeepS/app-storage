<script>
(function() {
  'use strict';

  function testCarbonStorageCompatibility(extendedContext) {
    var context = {
      tagName: 'unknown-element',
      awaitUpdate: function() {
        return Promise.resolve();
      },
      fetchStoredValue: function() {
        return Promise.resolve();
      }
    };

    function awaitStoredValue(storage, path) {
      return storage.transactionsComplete.then(function() {
        return context.fetchStoredValue(storage.memoryPathToStoragePath(path));
      });
    }

    Object.assign(context, extendedContext);

    suite('carbon storage compatibility: <' + context.tagName + '>', function() {
      suite('basic storage scenarios', function() {
        var storage;

        setup(function() {
          storage = fixture('BasicStorage');
          storage.set('data', {});
          return storage.transactionsComplete;
        });

        teardown(function() {
          storage.set('data', null);
          return storage.transactionsComplete;
        });

        suite('setting properties', function() {
          test('sets primitive values', function() {
            storage.set('data.numberProperty', 1);
            return awaitStoredValue(storage, 'data.numberProperty')
                .then(function(value) {
                  expect(value).to.be.equal(1);
                });
          });

          test('sets object values', function() {
            storage.set('data.objectProperty', { foo: 1 });
            return awaitStoredValue(storage, 'data.objectProperty')
                .then(function(value) {
                  expect(value).to.be.eql({
                    foo: 1
                  });
                });
          });

          test('sets array values', function() {
            storage.set('data.arrayProperty', [1, 2, 3]);
            return awaitStoredValue(storage, 'data.arrayProperty')
                .then(function(value) {
                  expect(value).to.be.eql([1, 2, 3]);
                });
          });
        });

        suite('updating properties', function() {
          test('updates primitive values', function() {
            storage.set('data.numberProperty', 1);

            return awaitStoredValue(storage, 'data.numberProperty')
                .then(function(value) {
                  storage.set('data.numberProperty', 2);
                  return awaitStoredValue(storage, 'data.numberProperty')
                }).then(function(value) {
                  expect(value).to.be.eql(2);
                });
          });

          test('updates object values', function() {
            storage.set('data.objectProperty', {
              foo: 1
            });

            return awaitStoredValue(storage, 'data.objectProperty')
                .then(function(value) {
                  storage.set('data.objectProperty.bar', 2);
                  return awaitStoredValue(storage, 'data.objectProperty');
                }).then(function(value) {
                  expect(value).to.be.eql({
                    foo: 1,
                    bar: 2
                  });
                });
          });

          test('updates array values', function() {
            storage.set('data.arrayProperty', [1, 2, 3]);

            return awaitStoredValue(storage, 'data.arrayProperty')
                .then(function(value) {
                  storage.set('data.arrayProperty', [1, 2, 3, 4]);
                  return awaitStoredValue(storage, 'data.arrayProperty');
                }).then(function(value) {
                  expect(value).to.be.eql([1, 2, 3, 4]);
                });
          });
        });

        suite('removing properties', function() {
          test('removes primitive values', function() {
            storage.set('data.numberProperty', 1);

            return awaitStoredValue(storage, 'data.numberProperty')
                .then(function() {
                  storage.set('data.numberProperty', null);
                  return awaitStoredValue(storage, 'data.numberProperty');
                }).then(function(value) {
                  expect(value).to.not.be.ok;
                });
          });

          test('removes object values', function() {
            storage.set('data.objectProperty', { foo: 1, bar: 2 });

            return awaitStoredValue(storage, 'data.objectProperty')
                .then(function() {
                  storage.set('data.objectProperty.bar', null);
                  return awaitStoredValue(storage, 'data.objectProperty');
                }).then(function(value) {
                  expect(value.foo).to.be.ok;
                  expect(value.bar).to.not.be.ok;
                });
          });

          test('removes array values', function() {
            storage.set('data.arrayProperty', [1, 2, 3]);

            return awaitStoredValue(storage, 'data.arrayProperty')
                .then(function() {
                  storage.pop('data.arrayProperty');
                  return awaitStoredValue(storage, 'data.arrayProperty');
                }).then(function(value) {
                  storage;
                  expect(value).to.be.eql([1, 2]);
                });
          });
        });
      });

      suite('syncing storage scenarios', function() {
        var storageOne;
        var storageTwo;

        setup(function() {
          var syncingStorage = fixture('SyncingStorage');

          storageOne = syncingStorage[0];
          storageTwo = syncingStorage[1];

          return Promise.all([
            storageOne.transactionsComplete,
            storageTwo.transactionsComplete
          ]);
        });

        teardown(function() {
          storageOne.set('data', null);
          storageTwo.set('data', null);

          return Promise.all([
            storageOne.transactionsComplete,
            storageTwo.transactionsComplete
          ]);
        });

        test('syncs primitives across elements', function() {
          storageOne.set('data.numberProperty', 1);

          return Promise.all([
            awaitStoredValue(storageOne, 'data.numberProperty'),
            context.awaitUpdate(storageTwo)
          ]).then(function(results) {
            var value = results[0];
            expect(value).to.be.equal(1);
            expect(storageOne.get('data.numberProperty')).to.be.equal(value);
            expect(storageTwo.get('data.numberProperty')).to.be.equal(value);
          });
        });
      });
    });
  }

  window.testCarbonStorageCompatibility =
      testCarbonStorageCompatibility;
})();
</script>
