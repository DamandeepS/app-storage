<link rel="import" href="carbon-offline-storage.html">
<script src="../firebase/firebase.js"></script>
<script>
  'use strict';

  Polymer({
    is: 'carbon-firebase-storage',

    extends: 'carbon-offline-storage',

    properties: {
      offlineNamespace: {
        type: String,
        computed: '__computeOfflineNamespace(location)'
      },

      location: {
        type: String,
        observer: '__locationChanged'
      },

      firebase: {
        type: Object,
        computed: '__computeFirebase(location, online)',
        observer: '__firebaseChanged'
      }
    },

    observers: [
      '__onlineChanged(online)'
    ],

    attached: function() {
      this.getPrototype('carbon-offline-storage').attached.call(this);
      this.__firebaseChanged(this.firebase, this.firebase);
    },

    detached: function() {
      this.getPrototype('carbon-offline-storage').detached.call(this);
      if (this.firebase) {
        this.firebase.off();
      }
    },

    get zeroValue() {
      return {};
    },

    getStoredValue: function(path) {
      return new Promise(function(resolve, reject) {
          this.firebase.child(path).once('value', function(snapshot) {
            var value = snapshot.val();
            if (value == null) {
              resolve(this.zeroValue);
            }
            resolve(value);
          }, this);
        }.bind(this));
    },

    setStoredValue: function(path, value) {
      this.__setFirebaseValue(path, value);
    },

    memoryPathToStoragePath: function(path) {
      return '/' + path.replace(/^data\.?/, '').split('.').join('/');
    },

    storagePathToMemoryPath: function(storagePath) {
      var path = 'data';

      storagePath =
          storagePath.replace('/', '').split('/').join('.');

      if (storagePath) {
        path += '.' + storagePath;
      }

      return path;
    },

    __computeFirebase: function(location, online) {
      return online ?
          new Firebase(location) :
          new Firebase(location, '__offline__');
    },

    __computeOfflineNamespace: function(location) {
      return 'carbon-firebase-storage_' + location;
    },

    __onlineChanged: function(online) {
      if (online) {
        Firebase.goOnline();
      } else {
        Firebase.goOffline();
      }
    },

    __locationChanged: function(location, oldLocation) {
      if (oldLocation != null && this.data != null) {
        this.data = null;
      }
    },

    __firebaseChanged: function(firebase, oldFirebase) {
      if (oldFirebase) {
        oldFirebase.off('value', this.__onFirebaseValue, this);
      }

      if (firebase) {
        firebase.on('value', this.__onFirebaseValue, this);
      }
    },

    __onFirebaseValue: function(snapshot) {
      var value = snapshot.val();

      if (value == null && this.valueIsEmpty(this.data)) {
        return;
      }

      if (!this.new) {
        this.async(function() {
          this.syncToMemory(function() {
            console.log('Updating data from Firebase value:', value);
            this.set('data', value);
          });
        });
      }
    },

    __setFirebaseValue: function(path, value) {
      console.log('Setting Firebase value at', path, 'to', value)
      return this.firebase.child(path).set(value);
    }
  });
</script>
