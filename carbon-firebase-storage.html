<link rel="import" href="carbon-network-status-behavior.html">
<link rel="import" href="carbon-storage.html">
<script src="../firebase/firebase.js"></script>
<script>
  'use strict';

  Polymer({
    is: 'carbon-firebase-storage',

    extends: 'carbon-storage',

    behaviors: [
      Polymer.CarbonNetworkStatusBehavior
    ],

    properties: {
      location: {
        type: String,
        observer: '__locationChanged'
      },

      firebase: {
        type: Object,
        computed: '__computeFirebase(location)',
        observer: '__firebaseChanged'
      }
    },

    observers: [
      '__onlineChanged(online)'
    ],

    attached: function() {
      this.__firebaseChanged(this.firebase, this.firebase);
    },

    detached: function() {
      if (this.firebase) {
        this.firebase.off();
      }
    },

    get zeroValue() {
      return {};
    },

    getStoredValue: function(path) {
      return new Promise(function(resolve, reject) {
          this.firebase.child(path).once('value', function(snapshot) {
            var value = snapshot.val();
            if (value == null) {
              resolve(this.zeroValue);
            }
            resolve(value);
          }, this);
        }.bind(this));
    },

    setStoredValue: function(path, value) {
      this.__setFirebaseValue(path, value);
    },

    memoryPathToStoragePath: function(path) {
      return '/' + path.replace(/^data\.?/, '').split('.').join('/');
    },

    storagePathToMemoryPath: function(storagePath) {
      var path = 'data';

      storagePath =
          storagePath.replace('/', '').split('/').join('.');

      if (storagePath) {
        path += '.' + storagePath;
      }

      return path;
    },

    __computeFirebase: function(location) {
      if (location == null) {
        return null;
      }

      return new Firebase(location);
    },

    __firebaseChanged: function(firebase, oldFirebase) {
      if (oldFirebase) {
        oldFirebase.off('value', this.__onFirebaseValue, this);
      }

      if (firebase) {
        firebase.on('value', this.__onFirebaseValue, this);
      }
    },

    __onlineChanged: function(online) {
      if (online) {
        Firebase.goOnline();
      } else {
        Firebase.goOffline();
      }
    },

    __locationChanged: function(location, oldLocation) {
      if (oldLocation != null && !this.valueIsEmpty(this.data)) {
        this.data = this.zeroValue;
      }
    },

    __onFirebaseValue: function(snapshot) {
      var value = snapshot.val();

      if (value == null && this.valueIsEmpty(this.data)) {
        value = this.zeroValue;
      }

      if (!this.new) {
        this.async(function() {
          this.syncToMemory(function() {
            this._log('Updating data from Firebase value:', value);
            this.set('data', value);
          });
        });
      }
    },

    __setFirebaseValue: function(path, value) {
      this._log('Setting Firebase value at', path, 'to', value)
      return this.firebase.child(path).set(value);
    }
  });
</script>
