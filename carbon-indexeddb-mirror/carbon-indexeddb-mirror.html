<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../carbon-storage-behavior.html">
<link rel="import" href="../carbon-network-status-behavior.html">
<link rel="import" href="carbon-indexeddb-mirror-client.html">
<dom-module id="carbon-indexeddb-mirror">
  <script>
    (() => {
      'use strict';

      Polymer({
        is: 'carbon-indexeddb-mirror',

        behaviors: [
          Polymer.CarbonStorageBehavior,
          Polymer.CarbonNetworkStatusBehavior
        ],

        properties: {
          key: {
            type: String,
            value: 'carbon-mirror-default-key'
          },

          session: {
            type: String,
            value: null
          },

          workerUrl: {
            type: String,
            value() {
              return this.resolveUrl('./carbon-indexeddb-mirror-worker.js');
            }
          },

          client: {
            type: Polymer.CarbonIndexedDBMirrorClient,
            computed: '__computeClient(workerUrl)'
          },

          persistedData: {
            type: Object,
            notify: true
          }
        },

        observers: [
          '__updatePersistedData(client, session, online, data)'
        ],

        get isNew() {
          return false;
        },

        setStoredValue(path, value) {
          return this.client.transaction('set', this.key, this.data);
        },

        getStoredValue(path) {
          return this.client.transaction('get', this.key);
        },

        initializeStoredValue() {
          return Promise.resolve();
        },

        __computeClient(workerUrl) {
          return new Polymer.CarbonIndexedDBMirrorClient(workerUrl);
        },

        __updatePersistedData(client, session, online, data) {
          this.client.validateSession(session);

          if (online) {
            this.persistedData = data;
            this.linkPaths('data', 'persistedData');
            this.linkPaths('persistedData', 'data');
          } else {
            this.unlinkPaths('data', 'persistedData');
            this.unlinkPaths('persistedData', 'data');
            this.getStoredValue().then(value => {
              // We may have gone online since retrieving the persisted value..
              if (this.online) {
                return;
              }
              this.persistedData = value;
            });
          }
        }
      });
    })();
  </script>
</dom-module>
