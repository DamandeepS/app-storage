<link rel="import" href="../../polymer/polymer.html">
<link rel="import" href="../app-storage-behavior.html">
<link rel="import" href="../app-network-status-behavior.html">
<link rel="import" href="app-indexeddb-mirror-client.html">
<dom-module id="app-indexeddb-mirror">
  <script>
    (() => {
      'use strict';

      Polymer({
        is: 'app-indexeddb-mirror',

        behaviors: [
          Polymer.AppStorageBehavior,
          Polymer.AppNetworkStatusBehavior
        ],

        properties: {
          key: {
            type: String,
            value: 'app-mirror-default-key'
          },

          session: {
            type: String,
            value: null
          },

          workerUrl: {
            type: String,
            value() {
              return this.resolveUrl('./app-indexeddb-mirror-worker.js');
            }
          },

          client: {
            type: Polymer.AppIndexedDBMirrorClient,
            computed: '__computeClient(workerUrl)'
          },

          persistedData: {
            type: Object,
            notify: true
          }
        },

        observers: [
          '__updatePersistedData(client, session, online, data)'
        ],

        get isNew() {
          return false;
        },

        destroy() {
          return this.client.transaction('set', this.key, null);
        },

        setStoredValue(path, value) {
          if (this.online) {
            return this.client.transaction('set', this.key, this.data);
          }

          return Promise.resolve();
        },

        getStoredValue(path) {
          return this.client.transaction('get', this.key);
        },

        initializeStoredValue() {
          return Promise.resolve();
        },

        __computeClient(workerUrl) {
          return new Polymer.AppIndexedDBMirrorClient(workerUrl);
        },

        __updatePersistedData(client, session, online, data) {
          this.client.validateSession(session);

          if (online) {
            this.persistedData = data;
            this.linkPaths('data', 'persistedData');
          } else {
            this.unlinkPaths('data', 'persistedData');
            this.getStoredValue().then(value => {
              // We may have gone online since retrieving the persisted value..
              if (this.online) {
                return;
              }
              this.persistedData = value;
            });
          }
        }
      });
    })();
  </script>
</dom-module>
