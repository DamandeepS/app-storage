<link rel="import" href="carbon-storage-behavior.html">
<link rel="import" href="carbon-network-status-behavior.html">
<link rel="import" href="carbon-mirror/carbon-mirror-client.html">
<dom-module id="carbon-mirror">
  <script>
    (() => {
      'use strict';

      Polymer({
        is: 'carbon-mirror',

        behaviors: [
          Polymer.CarbonStorageBehavior,
          Polymer.CarbonNetworkStatusBehavior
        ],

        properties: {
          store: {
            type: String,
            value: 'carbon-mirror-default-store'
          },

          workerUrl: {
            type: String,
            value() {
              return this.resolveUrl('carbon-mirror/carbon-mirror-worker.js');
            }
          },

          client: {
            type: Polymer.CarbonMirrorClient,
            computed: '__computeClient(workerUrl)'
          },

          persistedData: {
            type: Object,
            notify: true
          }
        },

        observers: [
          '__updatePersistedData(client, online, data)'
        ],

        get isNew() {
          return false;
        },

        setStoredValue(path, value) {
          console.log('set', arguments);
          return this.client.transaction('set', this.store, this.data);
        },

        getStoredValue(path) {
          console.log('get', arguments);
          return this.client.transaction('get', this.store);
        },

        initializeStoredValue() {
          return Promise.resolve();
        },

        __computeClient(workerUrl, workerScope) {
          return new Polymer.CarbonMirrorClient(workerUrl);
        },

        __updatePersistedData(client, online, data) {
          if (online) {
            this.persistedData = data;
            this.linkPaths('data', 'persistedData');
            this.linkPaths('persistedData', 'data');
          } else {
            this.unlinkPaths('data', 'persistedData');
            this.unlinkPaths('persistedData', 'data');
            this.getStoredValue().then((value) => {
              // We may have gone online since retrieving the persisted value..
              if (this.online) {
                return;
              }
              this.persistedData = value;
            });
          }
        }
      });
    })();
  </script>
</dom-module>
