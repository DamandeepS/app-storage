<link rel="import" href="carbon-network-status-behavior.html">
<link rel="import" href="carbon-storage.html">
<link rel="import" href="indexeddb.html">
<dom-module id="carbon-mirror">
  <script>
    (function() {
      'use strict'

      Polymer({
        is: 'carbon-mirror',

        extends: 'carbon-storage',

        behaviors: [
          Polymer.CarbonNetworkStatusBehavior
        ],

        properties: {
          location: {
            type: String,
            notify: true
          },

          stored: {
            type: Object,
            notify: true,
            readOnly: true
          },

          mirror: {
            type: Object,
            notify: true
          },

          db: {
            type: Object,
            readOnly: true
          }
        },

        observers: [
          '__selectMirror(db, location, online)',
          '__storedChanged(stored.*)',
          '__mirrorChanged(mirror.*)'
        ],

        ready: function() {
          this.__openDb();
        },

        clear: function() {
          idb.delete('carbon-mirror');
        },

        setStoredValue: function(path, value) {
          return this.getStoredValue(path).then(function(stored) {
            this.set(path, value, stored);

            var operation = stored ? 'add' : 'put';
            var transaction = this.db.transaction('stored_records');
            var store = transaction.objectStore('stored_records');

            return store[operation](this.location, stored);
          }.bind(this));
        },

        getStoredValue: function(path) {
          var transaction = this.db.transaction('stored_records', 'readonly');
          var store = transaction.objectStore('stored_records')

          return store.get(this.location).complete.then(function(value) {
                return this.get(path, value);
              }.bind(this));
        },

        __openDb: function() {
          idb.open('carbon-mirror', 0, this.__upgradeDb.bind(this))
              .then(function(db) {
                this._setDb(db);
              }.bind(this));
        },

        __upgradeDb: function(db) {
          var db = event.target.result;

          switch(db.oldVersion) {
            default:
              db.createObjectStore('stored_records', { keyPath: 'location' });
              break;
          }
        },

        __selectMirror: function(db, location, online) {
          if (online) {
            this._setMirror(this.data);
          } else {
            this._setMirror(this.stored);
          }
        },

        __onDbError: function(error) {
          console.error(error);
        }
      });
    })();
  </script>
</dom-module>
